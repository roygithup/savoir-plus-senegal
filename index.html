<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SVT Excellence | Plateforme de Cours</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Plus Jakarta Sans', 'sans-serif'] },
                    colors: {
                        brand: {
                            50: '#eff6ff', 100: '#dbeafe', 200: '#bfdbfe', 
                            500: '#3b82f6', 600: '#2563eb', 700: '#1d4ed8', 900: '#1e3a8a'
                        }
                    }
                }
            }
        }
    </script>

    <style>
        .glass-nav { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(12px); border-bottom: 1px solid rgba(226, 232, 240, 0.8); }
        .course-card { transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .course-card:hover { transform: translateY(-6px); box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1); }
        .shimmer { background: linear-gradient(90deg, #f0f0f0 25%, #f8f8f8 50%, #f0f0f0 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        .scale-in { animation: scaleIn 0.3s ease-out; }
        @keyframes scaleIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body class="bg-[#F8FAFC] text-slate-900 min-h-screen font-sans">

    <!-- NAVIGATION -->
    <nav class="glass-nav sticky top-0 z-50 px-6 py-3">
        <div class="max-w-7xl mx-auto flex items-center justify-between gap-4">
            <div class="flex items-center gap-2 flex-shrink-0">
                <div class="bg-brand-600 p-2 rounded-lg text-white">
                    <i class="fas fa-dna text-xl"></i>
                </div>
                <span class="text-xl font-bold tracking-tight text-brand-900 hidden sm:inline">SVT<span class="text-brand-600">Excellence</span></span>
            </div>

            <div class="relative flex-grow max-w-md hidden md:block">
                <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
                <input type="text" id="searchInput" placeholder="Rechercher une le√ßon..." class="w-full pl-11 pr-4 py-2 bg-slate-100 border-none rounded-xl focus:ring-2 focus:ring-brand-500 transition-all outline-none text-sm">
            </div>

            <div class="flex items-center gap-3" id="navAuthButtons">
                <button onclick="showAuthModal('login')" class="text-slate-600 font-semibold text-sm hover:text-brand-600 transition px-3 py-2">Connexion</button>
                <button onclick="showAuthModal('signup')" class="bg-brand-600 text-white px-5 py-2.5 rounded-xl font-bold text-sm shadow-md shadow-brand-200 hover:bg-brand-700 transition transform hover:scale-105 active:scale-95">S'inscrire</button>
            </div>
            <div class="hidden items-center gap-3" id="navUserDisplay">
                <button onclick="logout()" class="text-red-500 hover:bg-red-50 p-2 rounded-lg transition"><i class="fas fa-sign-out-alt"></i></button>
            </div>
        </div>
    </nav>

    <!-- BANNI√àRE DE BIENVENUE -->
    <div id="welcomeBanner" class="hidden bg-brand-900 text-white py-4 px-6">
        <div class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-brand-500 flex items-center justify-center font-bold text-white shadow-inner" id="userInitial">U</div>
                <div>
                    <p class="text-xs text-brand-300 font-medium">Content de te revoir,</p>
                    <p class="font-bold text-sm" id="welcomeUserText">Nom de l'√©l√®ve ‚Ä¢ Terminale</p>
                </div>
            </div>
            <div class="bg-white/10 px-4 py-2 rounded-xl text-xs italic text-brand-100 flex items-center gap-3">
                <i class="fas fa-quote-left opacity-50"></i>
                <span id="motivationQuote">L'√©ducation est l'arme la plus puissante pour changer le monde.</span>
            </div>
        </div>
    </div>

    <!-- HEADER -->
    <header class="bg-white border-b border-slate-100 px-6 py-12">
        <div class="max-w-7xl mx-auto flex flex-col md:flex-row md:items-end justify-between gap-8">
            <div>
                <h1 class="text-3xl font-extrabold text-slate-900 mb-2">Biblioth√®que de Cours</h1>
                <p class="text-slate-500">Acc√©dez √† l'excellence p√©dagogique en SVT.</p>
            </div>
            <div class="flex flex-wrap gap-2" id="filterContainer">
                <button data-filter="all" class="filter-btn px-5 py-2 rounded-full font-medium transition-all bg-brand-600 text-white text-sm">Tout</button>
                <button data-filter="Terminale" class="filter-btn px-5 py-2 rounded-full font-medium transition-all bg-slate-100 text-slate-600 hover:bg-slate-200 text-sm">Terminale</button>
                <button data-filter="3√®me" class="filter-btn px-5 py-2 rounded-full font-medium transition-all bg-slate-100 text-slate-600 hover:bg-slate-200 text-sm">3√®me</button>
                <button data-filter="free" class="filter-btn px-5 py-2 rounded-full font-medium transition-all bg-slate-100 text-slate-600 hover:bg-slate-200 text-green-600 text-sm">Gratuit</button>
            </div>
        </div>
    </header>

    <!-- CONTENU PRINCIPAL -->
    <main class="max-w-7xl mx-auto px-6 py-10">
        <div id="statusContainer" class="hidden text-center py-20">
            <div id="loader" class="hidden flex flex-col items-center">
                <div class="w-12 h-12 border-4 border-brand-200 border-t-brand-600 rounded-full animate-spin"></div>
            </div>
            <div id="noResults" class="hidden text-slate-400">
                <i class="fas fa-search text-4xl mb-4"></i>
                <h3 class="text-xl font-bold text-slate-800">Aucun r√©sultat trouv√©</h3>
            </div>
        </div>
        <div id="coursesGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            <div class="shimmer h-80 rounded-3xl opacity-50"></div>
            <div class="shimmer h-80 rounded-3xl opacity-50"></div>
            <div class="shimmer h-80 rounded-3xl opacity-50"></div>
        </div>
    </main>

    <!-- MODAL AUTH -->
    <div id="authModal" class="hidden fixed inset-0 z-[100] flex items-center justify-center p-6 bg-slate-900/60 backdrop-blur-sm">
        <div class="bg-white rounded-3xl p-8 max-w-md w-full shadow-2xl scale-in relative max-h-[90vh] overflow-y-auto">
            <button onclick="closeAuthModal()" class="absolute top-6 right-6 text-slate-400 hover:text-slate-600 transition">
                <i class="fas fa-times text-xl"></i>
            </button>
            
            <div class="text-center mb-6">
                <div class="w-14 h-14 bg-brand-50 text-brand-600 rounded-2xl flex items-center justify-center text-2xl mx-auto mb-4">
                    <i id="authIcon" class="fas fa-user-circle"></i>
                </div>
                <h2 id="authTitle" class="text-2xl font-extrabold text-slate-900">Bienvenue</h2>
                <p id="authSubtitle" class="text-slate-500 mt-1">L'excellence en SVT √† port√©e de main</p>
            </div>

            <form id="authForm" onsubmit="handleAuth(event)" class="space-y-4">
                <div id="signupFields" class="hidden space-y-4">
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-1.5 ml-1">Nom Complet</label>
                        <input type="text" id="regFullName" placeholder="Ex: Moussa Diop" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-brand-500 outline-none transition">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-1.5 ml-1">Classe</label>
                        <select id="regClasse" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-brand-500 outline-none transition appearance-none">
                            <option value="">Choisissez votre classe</option>
                            <option value="Terminale">Terminale</option>
                            <option value="3√®me">3√®me</option>
                        </select>
                    </div>
                </div>

                <div id="loginFields" class="space-y-4">
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-1.5 ml-1">Votre ID (4 caract√®res)</label>
                        <input type="text" id="loginID" maxlength="4" placeholder="Ex: A7B2" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-brand-500 outline-none transition uppercase text-center text-xl font-bold tracking-widest focus:bg-white">
                    </div>
                </div>
                
                <button type="submit" id="authSubmitBtn" class="w-full py-4 bg-brand-600 text-white rounded-2xl font-bold shadow-lg shadow-brand-200 hover:bg-brand-700 transition mt-2 flex items-center justify-center gap-2">
                    <span id="authBtnLabel">Se connecter</span>
                    <i class="fas fa-arrow-right text-xs"></i>
                </button>
            </form>

            <p class="mt-6 text-center text-sm text-slate-500">
                <span id="authFooterText">Nouveau ici ?</span>
                <button onclick="toggleAuthMode()" id="authFooterBtn" class="text-brand-600 font-bold hover:underline ml-1">S'inscrire</button>
            </p>
        </div>
    </div>

    <!-- MODAL PREMIUM / ACTIVATION -->
    <div id="premiumModal" class="hidden fixed inset-0 z-[100] flex items-center justify-center p-6 bg-slate-900/60 backdrop-blur-sm">
        <div class="bg-white rounded-3xl p-8 max-w-md w-full shadow-2xl scale-in">
            <div id="premiumIconContainer" class="w-16 h-16 bg-amber-100 text-amber-600 rounded-2xl flex items-center justify-center text-2xl mb-6">
                <i class="fas fa-crown"></i>
            </div>
            <h2 id="premiumModalTitle" class="text-2xl font-extrabold text-slate-900 mb-3">Acc√®s Premium requis</h2>
            <p id="premiumModalMsg" class="text-slate-600 mb-8 leading-relaxed">Cette le√ßon est r√©serv√©e aux abonn√©s actifs. Ton abonnement est peut-√™tre expir√© ou inactif.</p>
            <div class="flex flex-col gap-3">
                <button id="premiumWhatsappBtn" onclick="window.open('https://wa.me/221768776668', '_blank')" class="w-full py-4 bg-brand-600 text-white rounded-2xl font-bold shadow-lg shadow-brand-200 hover:bg-brand-700 transition flex items-center justify-center gap-2">
                    <i class="fab fa-whatsapp text-lg"></i>
                    <span>Activer / Renouveler sur WhatsApp</span>
                </button>
                <button onclick="closePremiumModal()" class="w-full py-3 bg-slate-50 text-slate-500 rounded-2xl font-medium hover:bg-slate-100 transition">Fermer</button>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://nqbyxogfvkmluakwmkmu.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_k5N9blQJIBSj2lW75GckOQ_CrLBqF9N'; 
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let allCourses = [];
        let currentFilter = 'all';
        let searchQuery = '';
        let currentAuthMode = 'login';
        let currentUser = JSON.parse(localStorage.getItem('svt_user_session')) || null;
        const ADMIN_PHONE = "221768776668";

        const quotes = [
            "L'√©ducation est l'arme la plus puissante pour changer le monde.",
            "Le succ√®s n'est pas final, l'√©chec n'est pas fatal : c'est le courage de continuer qui compte.",
            "Crois en toi et tu seras invincible.",
            "Le g√©nie, c'est 1% d'inspiration et 99% de transpiration.",
            "L'excellence n'est pas un acte, mais une habitude.",
            "Ta seule limite est celle que tu t'imposes."
        ];

        async function init() {
            updateUIForUser();
            showStatus('loader');
            try {
                const { data, error } = await supabaseClient.from('cours').select('*, cours_objectifs(*)');
                if (error) throw error;
                allCourses = data || [];
                render();
            } catch (err) { console.error(err); }
        }

        function updateUIForUser() {
            const authBtns = document.getElementById('navAuthButtons');
            const userDisplay = document.getElementById('navUserDisplay');
            const banner = document.getElementById('welcomeBanner');

            if (currentUser) {
                authBtns.classList.add('hidden');
                userDisplay.classList.remove('hidden');
                banner.classList.remove('hidden');
                
                document.getElementById('welcomeUserText').innerText = `${currentUser.nom} ‚Ä¢ ${currentUser.classe}`;
                document.getElementById('userInitial').innerText = currentUser.nom.charAt(0).toUpperCase();
                document.getElementById('motivationQuote').innerText = quotes[Math.floor(Math.random() * quotes.length)];
            } else {
                authBtns.classList.remove('hidden');
                userDisplay.classList.add('hidden');
                banner.classList.add('hidden');
            }
        }

        function generateEleveID() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; 
            let code = '';
            for (let i = 0; i < 4; i++) code += chars.charAt(Math.floor(Math.random() * chars.length));
            return code;
        }

        async function handleAuth(event) {
            event.preventDefault();
            const btn = document.getElementById('authSubmitBtn');
            const originalBtnHtml = btn.innerHTML;
            
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner animate-spin"></i> Traitement...';

            try {
                if (currentAuthMode === 'signup') {
                    const nom = document.getElementById('regFullName').value;
                    const classe = document.getElementById('regClasse').value;
                    const eleveID = generateEleveID();

                    if (!nom || !classe) {
                        alert("Merci de renseigner ton nom et ta classe.");
                        throw new Error("Champs manquants");
                    }

                    const { error: dbError } = await supabaseClient
                        .from('eleves') 
                        .insert([{ id: eleveID, nom: nom, classe: classe, actif: false }]);

                    if (dbError) throw dbError;

                    const message = `Bonjour SVT Excellence ! üëã\n\nNouvelle inscription :\nüÜî ID : ${eleveID}\nüë§ Nom : ${nom}\nüìö Classe : ${classe}\n\nMerci de m'activer !`;
                    const whatsappUrl = `https://wa.me/${ADMIN_PHONE}?text=${encodeURIComponent(message)}`;
                    
                    alert(`Compte cr√©√© avec succ√®s !\n\nTon ID est : [ ${eleveID} ]\n\nRedirection WhatsApp pour activation...`);
                    window.open(whatsappUrl, '_blank');
                    closeAuthModal();
                } else {
                    const enteredID = document.getElementById('loginID').value.toUpperCase();
                    
                    // 1. Chercher l'√©l√®ve d'abord sans filtre de date pour savoir s'il existe
                    const { data: user, error: userError } = await supabaseClient
                        .from('eleves')
                        .select('*')
                        .eq('id', enteredID)
                        .single();

                    if (userError || !user) {
                        throw new Error("ID introuvable. V√©rifie ton code ou inscris-toi.");
                    }

                    // 2. V√©rifier si actif et non expir√©
                    const now = new Date();
                    const expiration = user.date_expiration ? new Date(user.date_expiration) : null;
                    const isExpired = expiration ? now > expiration : true;

                    if (!user.actif || isExpired) {
                        // Afficher le message de bienvenue mais inciter √† l'abonnement
                        closeAuthModal();
                        showPremiumModal(
                            `Bienvenue, ${user.nom} !`,
                            `Ton acc√®s Premium est actuellement ${!user.actif ? 'inactif' : 'expir√©'}. Pour acc√©der √† toutes les le√ßons Premium et r√©ussir tes examens, contacte-nous sur WhatsApp pour activer ton abonnement.`,
                            "F√©licitations pour ton ID !"
                        );
                        return;
                    }

                    // 3. Connexion r√©ussie
                    currentUser = user;
                    localStorage.setItem('svt_user_session', JSON.stringify(user));
                    alert(`Bienvenue dans l'√©lite, ${user.nom} !`);
                    updateUIForUser();
                    closeAuthModal();
                    render();
                }
            } catch (err) {
                if(err.message !== "Champs manquants") alert(err.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalBtnHtml;
            }
        }

        function logout() {
            localStorage.removeItem('svt_user_session');
            currentUser = null;
            updateUIForUser();
            render();
            alert("Tu as √©t√© d√©connect√©.");
        }

        function render() {
            const grid = document.getElementById('coursesGrid');
            if (!grid) return;

            let filtered = allCourses.filter(c => {
                const matchesSearch = c.titre.toLowerCase().includes(searchQuery.toLowerCase());
                const matchesCategory = currentFilter === 'all' || c.classe === currentFilter || (currentFilter === 'free' && c.type_acces === 'free');
                return matchesSearch && matchesCategory;
            });

            grid.innerHTML = '';
            hideAllStatus();
            if (filtered.length === 0) { showStatus('noResults'); return; }

            filtered.forEach(course => {
                const isPremium = course.type_acces === 'premium';
                const card = document.createElement('div');
                card.className = `course-card bg-white rounded-[2rem] p-8 border border-slate-100 flex flex-col h-full relative group`;
                
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-6">
                        <div class="w-14 h-14 bg-brand-50 text-brand-600 rounded-2xl flex items-center justify-center text-2xl group-hover:bg-brand-600 group-hover:text-white transition-colors duration-500">
                            <i class="fas ${course.icone || 'fa-microscope'}"></i>
                        </div>
                        <span class="px-4 py-1.5 rounded-full text-xs font-bold uppercase tracking-wider ${isPremium ? 'bg-amber-100 text-amber-600' : 'bg-green-100 text-green-600'}">
                            ${isPremium ? '<i class="fas fa-crown mr-1"></i> Premium' : 'Gratuit'}
                        </span>
                    </div>
                    <div class="flex-grow">
                        <p class="text-brand-600 text-xs font-bold uppercase tracking-widest mb-2">${course.classe}</p>
                        <h3 class="text-xl font-bold text-slate-900 leading-tight mb-4">${course.titre}</h3>
                        <div class="space-y-3 mb-8">
                            ${(course.cours_objectifs || []).slice(0, 3).map(o => `<div class="flex items-start gap-3 text-sm text-slate-500"><i class="fas fa-circle text-[6px] mt-2 text-brand-300"></i><span>${o.description}</span></div>`).join('')}
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-3 pt-6 border-t border-slate-50">
                        <button onclick="handleAccess('${course.url_vid}', ${isPremium})" class="flex items-center justify-center gap-2 py-3 rounded-xl bg-slate-900 text-white font-bold text-sm hover:bg-brand-600 transition">Vid√©o</button>
                        <button onclick="handleAccess('${course.url_pdf}', ${isPremium})" class="flex items-center justify-center gap-2 py-3 rounded-xl bg-slate-100 text-slate-600 font-bold text-sm hover:bg-slate-200 transition">PDF</button>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        function handleAccess(url, isPremium) {
            if (isPremium && !currentUser) {
                showPremiumModal(
                    "Acc√®s Premium requis", 
                    "Cette le√ßon est r√©serv√©e aux abonn√©s actifs de SVT Excellence. Pour d√©bloquer ton plein potentiel, contacte-nous sur WhatsApp pour activer ton compte."
                );
            } else {
                window.open(url, '_blank');
            }
        }

        function showAuthModal(mode) {
            currentAuthMode = mode;
            const modal = document.getElementById('authModal');
            const signupFields = document.getElementById('signupFields');
            const loginFields = document.getElementById('loginFields');
            const title = document.getElementById('authTitle');
            const btnLabel = document.getElementById('authBtnLabel');
            const footerBtn = document.getElementById('authFooterBtn');
            const footerText = document.getElementById('authFooterText');

            if (!modal || !signupFields || !loginFields || !title || !btnLabel || !footerBtn || !footerText) return;

            if (mode === 'signup') {
                signupFields.classList.remove('hidden');
                loginFields.classList.add('hidden');
                title.innerText = "Rejoindre l'√©lite";
                btnLabel.innerText = "S'inscrire";
                footerText.innerText = "D√©j√† un ID ?";
                footerBtn.innerText = "Se connecter";
            } else {
                signupFields.classList.add('hidden');
                loginFields.classList.remove('hidden');
                title.innerText = "Content de te revoir";
                btnLabel.innerText = "Se connecter";
                footerText.innerText = "Nouveau ici ?";
                footerBtn.innerText = "S'inscrire";
            }
            modal.classList.remove('hidden');
        }

        function toggleAuthMode() { showAuthModal(currentAuthMode === 'login' ? 'signup' : 'login'); }
        
        function closeAuthModal() { 
            const modal = document.getElementById('authModal');
            if (modal) modal.classList.add('hidden'); 
            document.getElementById('authForm').reset();
        }

        function showPremiumModal(title, msg, badgeText = "Acc√®s Premium") { 
            const modal = document.getElementById('premiumModal');
            if (modal) {
                document.getElementById('premiumModalTitle').innerText = title || "Acc√®s Premium requis";
                document.getElementById('premiumModalMsg').innerText = msg || "Le√ßon r√©serv√©e aux abonn√©s.";
                modal.classList.remove('hidden');
            }
        }

        function closePremiumModal() { 
            const modal = document.getElementById('premiumModal');
            if (modal) modal.classList.add('hidden'); 
        }

        document.getElementById('searchInput')?.addEventListener('input', (e) => { searchQuery = e.target.value; render(); });
        
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.filter-btn').forEach(b => b.className = 'filter-btn px-5 py-2 rounded-full font-medium transition-all bg-slate-100 text-slate-600 hover:bg-slate-200 text-sm');
                btn.className = 'filter-btn px-5 py-2 rounded-full font-medium transition-all bg-brand-600 text-white text-sm';
                currentFilter = btn.dataset.filter;
                render();
            });
        });

        function showStatus(id) {
            hideAllStatus();
            document.getElementById('statusContainer').classList.remove('hidden');
            document.getElementById(id).classList.remove('hidden');
            document.getElementById('coursesGrid').classList.add('hidden');
        }

        function hideAllStatus() {
            document.getElementById('statusContainer').classList.add('hidden');
            document.getElementById('coursesGrid').classList.remove('hidden');
        }

        window.onload = init;
    </script>
</body>
</html>
